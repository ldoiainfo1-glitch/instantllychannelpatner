<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit Management - Admin Panel</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
    
    <style>
        body {
            padding-top: 76px;
            background: #f8f9fa;
        }
        
        .header-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        
        .stats-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .stats-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .table-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }
        
        .transfer-modal .modal-content {
            border-radius: 20px;
            border: none;
        }
        
        .user-search-item {
            padding: 0.75rem;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .user-search-item:hover {
            background: #f8f9fa;
        }
        
        .user-search-item.selected {
            background: #e7f1ff;
            border-left: 4px solid #667eea;
        }
        
        .search-results-box {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            margin-top: 0.5rem;
        }
        
        .badge-sent {
            background: #dc3545;
        }
        
        .badge-received {
            background: #28a745;
        }
        
        .badge-bonus {
            background: #ffc107;
            color: #000;
        }
        
        .filter-tabs .nav-link {
            color: #667eea;
            font-weight: 500;
        }
        
        .filter-tabs .nav-link.active {
            background: #667eea;
            color: white;
        }
        
        .amount-positive {
            color: #28a745;
            font-weight: 600;
        }
        
        .amount-negative {
            color: #dc3545;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold d-flex align-items-center" href="index.html">
                <img src="images/logo.jpeg" alt="Logo" height="45" class="me-3 navbar-logo">
                <span>Instantly Cards</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html"><i class="fas fa-home me-1"></i> Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="profile.html"><i class="fas fa-user me-1"></i> Profile</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="ads.html"><i class="fas fa-bullhorn me-1"></i> My Ads</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="admin-credits.html"><i class="fas fa-coins me-1"></i> Credits</a>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-outline-light btn-sm ms-2" onclick="logout()">
                            <i class="fas fa-sign-out-alt me-1"></i> Logout
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <div class="header-section">
        <div class="container">
            <h2><i class="fas fa-coins me-2"></i> Credit Management System</h2>
            <p class="mb-0">Monitor and manage all credit transactions</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Stats Row -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="stats-card card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="stats-icon bg-primary bg-opacity-10 text-primary me-3">
                                <i class="fas fa-users"></i>
                            </div>
                            <div>
                                <h6 class="text-muted mb-1">Total Users</h6>
                                <h3 class="mb-0" id="totalUsers">-</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="stats-card card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="stats-icon bg-success bg-opacity-10 text-success me-3">
                                <i class="fas fa-coins"></i>
                            </div>
                            <div>
                                <h6 class="text-muted mb-1">Total Credits</h6>
                                <h3 class="mb-0" id="totalCredits">-</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="stats-card card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="stats-icon bg-warning bg-opacity-10 text-warning me-3">
                                <i class="fas fa-exchange-alt"></i>
                            </div>
                            <div>
                                <h6 class="text-muted mb-1">Transfers Today</h6>
                                <h3 class="mb-0" id="transfersToday">-</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="stats-card card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="stats-icon bg-danger bg-opacity-10 text-danger me-3">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div>
                                <h6 class="text-muted mb-1">Credits Moved</h6>
                                <h3 class="mb-0" id="creditsMoved">-</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Transfer Section -->
        <div class="table-card mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="fas fa-paper-plane me-2"></i>Admin Transfer Credits</h5>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#transferModal">
                    <i class="fas fa-plus me-2"></i>New Transfer
                </button>
            </div>
            <p class="text-muted">Transfer credits to any user by searching their phone number</p>
        </div>

        <!-- Transactions Table -->
        <div class="table-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>All Credit Transactions</h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshTransactions()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="exportToCSV()">
                        <i class="fas fa-download me-1"></i>Export CSV
                    </button>
                </div>
            </div>

            <!-- Filter Tabs -->
            <ul class="nav nav-tabs filter-tabs mb-3">
                <li class="nav-item">
                    <a class="nav-link active" href="#" onclick="filterTransactions('all')">All</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="filterTransactions('transfer_sent')">Transfers</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="filterTransactions('signup_bonus')">Signup Bonus</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="filterTransactions('referral_bonus')">Referral Bonus</a>
                </li>
            </ul>

            <!-- Search and Filters -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <input type="text" class="form-control" id="searchTransaction" 
                           placeholder="Search by user name or phone..." 
                           oninput="searchTransactions()">
                </div>
                <div class="col-md-3">
                    <input type="date" class="form-control" id="dateFilter" onchange="applyDateFilter()">
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="limitFilter" onchange="loadTransactions()">
                        <option value="50">50 per page</option>
                        <option value="100">100 per page</option>
                        <option value="200">200 per page</option>
                        <option value="500">500 per page</option>
                    </select>
                </div>
            </div>

            <!-- Table -->
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Date & Time</th>
                            <th>Type</th>
                            <th>From</th>
                            <th>To</th>
                            <th>Amount</th>
                            <th>Balance After</th>
                            <th>Description</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTableBody">
                        <tr>
                            <td colspan="8" class="text-center py-5">
                                <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                <p class="text-muted mb-0">Loading transactions...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div id="paginationInfo" class="text-muted">-</div>
                <nav>
                    <ul class="pagination mb-0" id="paginationControls"></ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Transfer Modal -->
    <div class="modal fade transfer-modal" id="transferModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title"><i class="fas fa-paper-plane me-2"></i>Transfer Credits</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Search User -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Search User by Phone Number</label>
                        <input type="text" class="form-control form-control-lg" id="modalPhoneSearch" 
                               placeholder="Type phone number (e.g., 88, 9768...)" autocomplete="off">
                        <small class="text-muted">Start typing to see matching users</small>
                        
                        <!-- Search Results -->
                        <div class="search-results-box d-none" id="modalSearchResults"></div>
                    </div>

                    <!-- Selected User Display -->
                    <div id="modalSelectedUser" class="d-none mb-3">
                        <div class="alert alert-info d-flex justify-content-between align-items-center">
                            <div>
                                <strong id="modalSelectedUserName">-</strong><br>
                                <small id="modalSelectedUserPhone">-</small><br>
                                <small class="text-muted">Current Balance: <span id="modalSelectedUserBalance">-</span></small>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="clearModalSelection()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Amount -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Transfer Amount</label>
                        <input type="number" class="form-control form-control-lg" id="modalAmount" 
                               placeholder="Enter amount" min="1" step="1">
                        
                        <!-- Quick Amounts -->
                        <div class="btn-group w-100 mt-2" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setModalAmount(1000)">1K</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setModalAmount(5000)">5K</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setModalAmount(10000)">10K</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setModalAmount(50000)">50K</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setModalAmount(100000)">1L</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setModalAmount(500000)">5L</button>
                        </div>
                    </div>

                    <!-- Note -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Note (Optional)</label>
                        <textarea class="form-control" id="modalNote" rows="2" 
                                  placeholder="Add a note for this transfer..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="modalTransferBtn" onclick="executeModalTransfer()" disabled>
                        <i class="fas fa-paper-plane me-2"></i>Transfer Credits
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_BASE_URL = 'https://instantlly-cards-backend-6ki0.onrender.com/api';
        
        let allTransactions = [];
        let filteredTransactions = [];
        let currentFilter = 'all';
        let currentPage = 1;
        let itemsPerPage = 50;
        let selectedModalUser = null;
        let searchTimeout = null;

        // Check admin auth
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('channelPartnerToken');
            if (!token) {
                window.location.href = 'index.html';
                return;
            }
            
            loadStats();
            loadTransactions();
            setupModalListeners();
        });

        function setupModalListeners() {
            // Phone search with debounce
            document.getElementById('modalPhoneSearch').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();
                
                if (query.length > 0) {
                    searchTimeout = setTimeout(() => searchModalUsers(query), 300);
                } else {
                    document.getElementById('modalSearchResults').classList.add('d-none');
                }
            });

            // Amount validation
            document.getElementById('modalAmount').addEventListener('input', validateModalForm);
        }

        async function loadStats() {
            try {
                const token = localStorage.getItem('channelPartnerToken');
                
                // Load user stats
                const usersRes = await fetch(`${API_BASE_URL}/admin/users-stats`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    }
                });
                
                if (usersRes.ok) {
                    const userData = await usersRes.json();
                    document.getElementById('totalUsers').textContent = (userData.totalUsers || 0).toLocaleString('en-IN');
                    document.getElementById('totalCredits').textContent = (userData.totalCredits || 0).toLocaleString('en-IN');
                }
            } catch (error) {
                console.error('Stats loading error:', error);
            }
        }

        async function loadTransactions() {
            try {
                itemsPerPage = parseInt(document.getElementById('limitFilter').value);
                
                const token = localStorage.getItem('channelPartnerToken');
                const response = await fetch(`${API_BASE_URL}/admin/all-transactions?limit=1000`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    allTransactions = data.transactions || [];
                    filteredTransactions = allTransactions;
                    
                    // Calculate today's stats
                    const today = new Date().toDateString();
                    const todayTransfers = allTransactions.filter(t => 
                        new Date(t.createdAt).toDateString() === today && 
                        (t.type === 'transfer_sent' || t.type === 'transfer_received')
                    );
                    const todayAmount = todayTransfers.reduce((sum, t) => sum + t.amount, 0);
                    
                    document.getElementById('transfersToday').textContent = (todayTransfers.length / 2).toFixed(0);
                    document.getElementById('creditsMoved').textContent = (todayAmount / 2).toLocaleString('en-IN');
                    
                    displayTransactions();
                } else {
                    showError('Failed to load transactions');
                }
            } catch (error) {
                console.error('Load transactions error:', error);
                showError('Error loading transactions');
            }
        }

        function displayTransactions() {
            const tbody = document.getElementById('transactionsTableBody');
            
            if (filteredTransactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-5">
                            <i class="fas fa-inbox fa-2x mb-2 text-muted"></i>
                            <p class="text-muted mb-0">No transactions found</p>
                        </td>
                    </tr>
                `;
                return;
            }

            // Pagination
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageTransactions = filteredTransactions.slice(start, end);

            tbody.innerHTML = pageTransactions.map(tx => {
                const date = new Date(tx.createdAt).toLocaleString('en-IN', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const typeInfo = getTypeInfo(tx.type);
                const fromUser = tx.fromUser?.name || '-';
                const toUser = tx.toUser?.name || '-';
                const fromPhone = tx.fromUser?.phone || '';
                const toPhone = tx.toUser?.phone || '';

                return `
                    <tr>
                        <td>${date}</td>
                        <td><span class="badge ${typeInfo.class}">${typeInfo.label}</span></td>
                        <td>
                            ${fromUser}
                            ${fromPhone ? `<br><small class="text-muted">${fromPhone}</small>` : ''}
                        </td>
                        <td>
                            ${toUser}
                            ${toPhone ? `<br><small class="text-muted">${toPhone}</small>` : ''}
                        </td>
                        <td class="${tx.type.includes('received') || tx.type.includes('bonus') ? 'amount-positive' : 'amount-negative'}">
                            ${tx.type.includes('received') || tx.type.includes('bonus') ? '+' : '-'}${tx.amount.toLocaleString('en-IN')}
                        </td>
                        <td>${tx.balanceAfter.toLocaleString('en-IN')}</td>
                        <td>${tx.description || '-'}</td>
                        <td><span class="badge bg-success">Completed</span></td>
                    </tr>
                `;
            }).join('');

            updatePagination();
        }

        function getTypeInfo(type) {
            const types = {
                'transfer_sent': { label: 'Transfer Sent', class: 'badge-sent' },
                'transfer_received': { label: 'Transfer Received', class: 'badge-received' },
                'signup_bonus': { label: 'Signup Bonus', class: 'badge-bonus' },
                'referral_bonus': { label: 'Referral Bonus', class: 'badge-bonus' },
                'admin_credit': { label: 'Admin Credit', class: 'bg-primary' }
            };
            return types[type] || { label: type, class: 'bg-secondary' };
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            const start = (currentPage - 1) * itemsPerPage + 1;
            const end = Math.min(start + itemsPerPage - 1, filteredTransactions.length);

            document.getElementById('paginationInfo').textContent = 
                `Showing ${start}-${end} of ${filteredTransactions.length} transactions`;

            let paginationHTML = '';
            
            if (currentPage > 1) {
                paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a></li>`;
            }
            
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHTML += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }
            
            if (currentPage < totalPages) {
                paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a></li>`;
            }

            document.getElementById('paginationControls').innerHTML = paginationHTML;
        }

        function changePage(page) {
            currentPage = page;
            displayTransactions();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function filterTransactions(type) {
            currentFilter = type;
            currentPage = 1;
            
            // Update active tab
            document.querySelectorAll('.filter-tabs .nav-link').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (type === 'all') {
                filteredTransactions = allTransactions;
            } else {
                filteredTransactions = allTransactions.filter(tx => tx.type === type);
            }
            
            displayTransactions();
        }

        function searchTransactions() {
            const query = document.getElementById('searchTransaction').value.toLowerCase();
            
            if (!query) {
                filteredTransactions = currentFilter === 'all' ? allTransactions : 
                    allTransactions.filter(tx => tx.type === currentFilter);
            } else {
                const baseTransactions = currentFilter === 'all' ? allTransactions : 
                    allTransactions.filter(tx => tx.type === currentFilter);
                    
                filteredTransactions = baseTransactions.filter(tx => 
                    tx.fromUser?.name?.toLowerCase().includes(query) ||
                    tx.toUser?.name?.toLowerCase().includes(query) ||
                    tx.fromUser?.phone?.includes(query) ||
                    tx.toUser?.phone?.includes(query) ||
                    tx.description?.toLowerCase().includes(query)
                );
            }
            
            currentPage = 1;
            displayTransactions();
        }

        function applyDateFilter() {
            const dateStr = document.getElementById('dateFilter').value;
            if (!dateStr) {
                loadTransactions();
                return;
            }
            
            const filterDate = new Date(dateStr).toDateString();
            filteredTransactions = allTransactions.filter(tx => 
                new Date(tx.createdAt).toDateString() === filterDate
            );
            
            currentPage = 1;
            displayTransactions();
        }

        function refreshTransactions() {
            loadTransactions();
        }

        function exportToCSV() {
            const headers = ['Date', 'Type', 'From', 'To', 'Amount', 'Balance After', 'Description', 'Status'];
            const rows = filteredTransactions.map(tx => [
                new Date(tx.createdAt).toLocaleString('en-IN'),
                tx.type,
                tx.fromUser?.name || '-',
                tx.toUser?.name || '-',
                tx.amount,
                tx.balanceAfter,
                tx.description || '-',
                'Completed'
            ]);
            
            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `credit-transactions-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // Modal Functions
        async function searchModalUsers(query) {
            try {
                const token = localStorage.getItem('channelPartnerToken');
                const response = await fetch(`${API_BASE_URL}/credits/search-users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ phonePrefix: query })
                });

                if (response.ok) {
                    const data = await response.json();
                    displayModalSearchResults(data.users || []);
                }
            } catch (error) {
                console.error('Modal search error:', error);
            }
        }

        function displayModalSearchResults(users) {
            const resultsDiv = document.getElementById('modalSearchResults');
            
            if (users.length === 0) {
                resultsDiv.innerHTML = '<div class="text-center py-3 text-muted">No users found</div>';
                resultsDiv.classList.remove('d-none');
                return;
            }

            resultsDiv.innerHTML = users.map(user => `
                <div class="user-search-item" onclick='selectModalUser(${JSON.stringify(user)})'>
                    <strong>${user.name}</strong><br>
                    <small class="text-muted">${user.displayPhone}</small>
                </div>
            `).join('');
            
            resultsDiv.classList.remove('d-none');
        }

        function selectModalUser(user) {
            selectedModalUser = user;
            
            document.getElementById('modalSearchResults').classList.add('d-none');
            document.getElementById('modalPhoneSearch').value = user.displayPhone;
            
            document.getElementById('modalSelectedUser').classList.remove('d-none');
            document.getElementById('modalSelectedUserName').textContent = user.name;
            document.getElementById('modalSelectedUserPhone').textContent = user.displayPhone;
            document.getElementById('modalSelectedUserBalance').textContent = 'Loading...';
            
            // Load user balance
            loadUserBalance(user._id);
            
            validateModalForm();
        }

        async function loadUserBalance(userId) {
            try {
                const token = localStorage.getItem('channelPartnerToken');
                const response = await fetch(`${API_BASE_URL}/admin/user/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('modalSelectedUserBalance').textContent = 
                        (data.user.credits || 0).toLocaleString('en-IN') + ' credits';
                }
            } catch (error) {
                console.error('Load balance error:', error);
            }
        }

        function clearModalSelection() {
            selectedModalUser = null;
            document.getElementById('modalSelectedUser').classList.add('d-none');
            document.getElementById('modalPhoneSearch').value = '';
            validateModalForm();
        }

        function setModalAmount(amount) {
            document.getElementById('modalAmount').value = amount;
            validateModalForm();
        }

        function validateModalForm() {
            const amount = parseInt(document.getElementById('modalAmount').value) || 0;
            const transferBtn = document.getElementById('modalTransferBtn');
            
            const isValid = selectedModalUser && amount > 0;
            transferBtn.disabled = !isValid;
        }

        async function executeModalTransfer() {
            if (!selectedModalUser) {
                alert('Please select a user');
                return;
            }

            const amount = parseInt(document.getElementById('modalAmount').value);
            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }

            const note = document.getElementById('modalNote').value.trim();
            const transferBtn = document.getElementById('modalTransferBtn');
            
            transferBtn.disabled = true;
            transferBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

            try {
                const token = localStorage.getItem('channelPartnerToken');
                const response = await fetch(`${API_BASE_URL}/admin/transfer-credits`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify({
                        toUserId: selectedModalUser._id,
                        amount: amount,
                        description: note || `Admin credit - ${amount.toLocaleString('en-IN')} credits`
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`Successfully transferred ${amount.toLocaleString('en-IN')} credits to ${selectedModalUser.name}`);
                    
                    // Close modal
                    bootstrap.Modal.getInstance(document.getElementById('transferModal')).hide();
                    
                    // Reset form
                    clearModalSelection();
                    document.getElementById('modalAmount').value = '';
                    document.getElementById('modalNote').value = '';
                    
                    // Reload transactions
                    loadTransactions();
                    loadStats();
                } else {
                    alert(data.message || 'Transfer failed');
                }
            } catch (error) {
                console.error('Transfer error:', error);
                alert('Transfer failed. Please try again.');
            } finally {
                transferBtn.disabled = false;
                transferBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Transfer Credits';
            }
        }

        function showError(message) {
            const tbody = document.getElementById('transactionsTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-5">
                        <i class="fas fa-exclamation-circle fa-2x mb-2 text-danger"></i>
                        <p class="text-danger mb-0">${message}</p>
                    </td>
                </tr>
            `;
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('channelPartnerToken');
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>
