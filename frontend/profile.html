<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Instantly Channel Partner</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
    
    <style>
        body {
            padding-top: 70px; /* Account for fixed navbar */
            background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
        }
        
        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.8rem 0;
            position: relative;
            overflow: hidden;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.2);
        }
        
        .profile-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.9) 0%, rgba(118, 75, 162, 0.9) 100%);
            z-index: 0;
        }
        
        .profile-header > * {
            position: relative;
            z-index: 1;
        }
        
        .profile-photo-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }
        
        .profile-photo {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border: 4px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border-radius: 50%;
        }
        
        .photo-upload-btn {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: #667eea;
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .photo-upload-btn:hover {
            background: #764ba2;
            transform: scale(1.1);
        }
        
        .credits-card {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            border: none;
            color: #333;
            box-shadow: 0 4px 15px rgba(255, 154, 158, 0.3);
        }
        
        .stats-card {
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }
        
        .info-card {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .edit-mode input,
        .edit-mode textarea {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
        }
        
        .nav-tabs .nav-link {
            color: #3b82f6;
            font-weight: 500;
            border: none;
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        /* Login Form Styles */
        #loginForm input:focus {
            border-color: #667eea !important;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
            outline: none;
        }
        
        #loginForm button[type="submit"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        #loginForm button[type="submit"]:active {
            transform: translateY(0);
        }
        
        .login-card-shadow {
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold d-flex align-items-center" href="index.html">
                <img src="images/logo.jpeg" alt="Instantly Cards Logo" height="45" class="me-3 navbar-logo">
                <div>
                    <div style="font-size: 1.25rem; font-weight: 700; color: #3b82f6;">Instantly Channel Partner</div>
                    <div style="font-size: 0.75rem; color: #6b7280;">Channel Partner Dashboard</div>
                </div>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html" style="color: #374151;">
                            <i class="fas fa-home me-1"></i>Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="profile.html" style="color: #3b82f6;">
                            <i class="fas fa-user-circle me-1"></i>Profile
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="goToPromotions(); return false;" style="color: #374151;">
                            <i class="fas fa-bullhorn me-1"></i>Promotions
                        </a>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-danger btn-sm ms-2" onclick="logout()" style="color: white; border-color: #dc3545;">
                            <i class="fas fa-sign-out-alt me-1"></i>Logout
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Login Section (shown when not logged in) -->
    <section class="profile-header" id="loginSection" style="min-height: 100vh; display: flex; align-items: center;">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-5 col-lg-4">
                    <div class="card shadow-lg border-0" style="border-radius: 16px; overflow: hidden;">
                        <!-- Card Header -->
                        <div class="card-header text-center py-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                            <div class="mb-2">
                                <i class="fas fa-user-circle fa-3x text-white"></i>
                            </div>
                            <h4 class="mb-1 text-white fw-bold">Channel Partner Login</h4>
                            <p class="mb-0 text-white-50" style="font-size: 14px;">Access your dashboard</p>
                        </div>
                        
                        <!-- Card Body -->
                        <div class="card-body p-4">
                            <div id="loginError" class="alert alert-danger d-none" style="font-size: 13px;"></div>
                            
                            <form id="loginForm">
                                <div class="mb-3">
                                    <label for="loginPhone" class="form-label fw-semibold" style="font-size: 14px; color: #374151;">
                                        <i class="fas fa-phone me-2 text-primary"></i>Phone Number
                                    </label>
                                    <input type="tel" class="form-control form-control-lg" id="loginPhone" 
                                           placeholder="Enter your phone number" required 
                                           style="font-size: 15px; border: 2px solid #e5e7eb; border-radius: 8px; padding: 12px;">
                                    <small class="form-text text-muted" style="font-size: 12px;">
                                        <i class="fas fa-info-circle me-1"></i>Use your registered phone number
                                    </small>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="loginPassword" class="form-label fw-semibold" style="font-size: 14px; color: #374151;">
                                        <i class="fas fa-lock me-2 text-primary"></i>Password
                                    </label>
                                    <div class="input-group">
                                        <input type="password" class="form-control form-control-lg" id="loginPassword" 
                                               placeholder="Enter your password" required
                                               style="font-size: 15px; border: 2px solid #e5e7eb; border-radius: 8px 0 0 8px; padding: 12px;">
                                        <button class="btn btn-outline-secondary" type="button" id="toggleLoginPassword" 
                                                style="border: 2px solid #e5e7eb; border-left: none; border-radius: 0 8px 8px 0;">
                                            <i class="fas fa-eye" id="toggleLoginPasswordIcon"></i>
                                        </button>
                                    </div>
                                    <small class="form-text text-muted" style="font-size: 12px;">
                                        <i class="fas fa-key me-1"></i>Default: First 4 letters of name in CAPITAL (e.g., "MUSK")
                                    </small>
                                </div>
                                
                                <button type="submit" class="btn btn-lg w-100 mt-3" 
                                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                               border: none; 
                                               color: white; 
                                               font-size: 16px; 
                                               font-weight: 600; 
                                               padding: 14px;
                                               border-radius: 8px;
                                               transition: transform 0.2s;">
                                    <i class="fas fa-sign-in-alt me-2"></i>Login to Dashboard
                                </button>
                            </form>
                        </div>
                        
                        <!-- Card Footer -->
                        <div class="card-footer text-center py-3" style="background: #f9fafb; border-top: 1px solid #e5e7eb;">
                            <small class="text-muted d-block mb-2" style="font-size: 12px;">
                                <i class="fas fa-shield-alt me-1 text-success"></i>
                                Account created automatically when your application is approved
                            </small>
                            <a href="index.html" class="btn btn-outline-secondary btn-sm" 
                               style="font-size: 13px; border-radius: 6px; padding: 6px 20px;">
                                <i class="fas fa-arrow-left me-2"></i>Back to Home
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Profile Header -->
    <section class="profile-header" id="profileSection" style="display: none;">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-3 text-center">
                    <div class="profile-photo-container">
                        <img src="" alt="Profile Photo" id="profilePhoto" class="rounded-circle profile-photo">
                        <label for="photoUpload" class="photo-upload-btn">
                            <i class="fas fa-camera"></i>
                        </label>
                        <input type="file" id="photoUpload" accept="image/*" style="display: none;">
                    </div>
                </div>
                <div class="col-md-6">
                    <h2 class="mb-2 text-white" id="userName">Loading...</h2>
                    <p class="mb-1 text-white">
                        <i class="fas fa-phone me-2"></i>
                        <span id="userPhone">-</span>
                    </p>
                    <p class="mb-0 text-white">
                        <i class="fas fa-envelope me-2"></i>
                        <span id="userEmail">-</span>
                    </p>
                </div>
                <div class="col-md-3">
                    <div class="card credits-card">
                        <div class="card-body text-center">
                            <h6 class="mb-2">
                                <i class="fas fa-coins me-2"></i>Available Credits
                            </h6>
                            <h1 class="mb-3" id="userCredits">0</h1>
                            <small class="text-muted">Use Transfer tab below to send credits</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <section class="py-5 bg-light">
        <div class="container">
            <!-- Stats Row -->
            <div class="row mb-4">
                <div class="col-md-4 mb-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <div class="mb-2">
                                <i class="fas fa-user-friends fa-2x text-primary"></i>
                            </div>
                            <h4 class="mb-0" id="introducedCount">0</h4>
                            <p class="text-muted mb-0">People Introduced</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <div class="mb-2">
                                <i class="fas fa-briefcase fa-2x text-success"></i>
                            </div>
                            <h4 class="mb-0" id="totalApplications">0</h4>
                            <p class="text-muted mb-0">Total Applications</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <div class="mb-2">
                                <i class="fas fa-check-circle fa-2x text-info"></i>
                            </div>
                            <h4 class="mb-0" id="approvedApplications">0</h4>
                            <p class="text-muted mb-0">Approved Positions</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <ul class="nav nav-tabs mb-4" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#profileTab">
                        <i class="fas fa-user me-2"></i>Profile Information
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#applicationsTab">
                        <i class="fas fa-file-alt me-2"></i>My Applications
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#creditsTab">
                        <i class="fas fa-history me-2"></i>Credits History
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#transferTab">
                        <i class="fas fa-exchange-alt me-2"></i>Transfer Credits
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#securityTab">
                        <i class="fas fa-lock me-2"></i>Security
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#documentsTab">
                        <i class="fas fa-file-upload me-2"></i>Documents
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#adsTab">
                        <i class="fas fa-ad me-2"></i>My Advertisements
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Profile Tab -->
                <div class="tab-pane fade show active" id="profileTab">
                    <div class="info-card">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4 class="mb-0">
                                <i class="fas fa-user me-2"></i>Personal Information
                            </h4>
                            <button class="btn btn-primary" id="editProfileBtn" onclick="toggleEditMode()">
                                <i class="fas fa-edit me-2"></i>Edit Profile
                            </button>
                        </div>

                        <form id="profileForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-user me-2"></i>Full Name
                                    </label>
                                    <input type="text" class="form-control" id="editName" readonly>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-phone me-2"></i>Phone Number
                                    </label>
                                    <input type="tel" class="form-control" id="editPhone" readonly disabled>
                                    <small class="text-muted">Phone number cannot be changed</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-envelope me-2"></i>Email Address
                                    </label>
                                    <input type="email" class="form-control" id="editEmail" readonly>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-user-friends me-2"></i>Introduced By
                                    </label>
                                    <input type="text" class="form-control" id="editIntroducedBy" readonly disabled>
                                </div>
                            </div>

                            <div class="text-end d-none" id="profileActions">
                                <button type="button" class="btn btn-secondary me-2" onclick="cancelEditMode()">
                                    <i class="fas fa-times me-2"></i>Cancel
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-2"></i>Save Changes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Applications Tab -->
                <div class="tab-pane fade" id="applicationsTab">
                    <div class="info-card">
                        <h4 class="mb-4">
                            <i class="fas fa-file-alt me-2"></i>My Applications
                        </h4>
                        <div id="applicationsList">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-3 text-muted">Loading applications...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Credits History Tab -->
                <div class="tab-pane fade" id="creditsTab">
                    <div class="info-card">
                        <h4 class="mb-4">
                            <i class="fas fa-history me-2"></i>Credits History
                        </h4>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Initial Credits:</strong> You received 5,00,000 credits when your first application was approved!
                        </div>
                        <div id="creditsHistory">
                            <div class="list-group">
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-plus-circle text-success me-2"></i>
                                            <strong>Initial Credits Granted</strong>
                                            <br>
                                            <small class="text-muted">Welcome bonus on first approval</small>
                                        </div>
                                        <div class="text-end">
                                            <h5 class="mb-0 text-success">+5,00,000</h5>
                                            <small class="text-muted" id="creditsDate">-</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transfer Credits Tab -->
                <div class="tab-pane fade" id="transferTab">
                    <div class="info-card">
                        <h4 class="mb-4">
                            <i class="fas fa-exchange-alt me-2"></i>Transfer Credits
                        </h4>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Available Balance:</strong> <span id="transferAvailableCredits" class="fw-bold">0</span> credits
                        </div>

                        <form id="transferForm" onsubmit="handleTransferCredits(event)">
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-phone me-2"></i>Recipient Phone Number
                                    </label>
                                    <input 
                                        type="text" 
                                        class="form-control" 
                                        id="transferPhone" 
                                        placeholder="Type any digits to search (e.g., 700, 88, 996...)" 
                                        autocomplete="off">
                                    <small class="text-muted">Search users by typing any part of their phone number</small>
                                    
                                    <!-- User dropdown -->
                                    <div id="userDropdown" class="list-group mt-2" style="display: none; max-height: 300px; overflow-y: auto;"></div>
                                </div>

                                <!-- Selected user display -->
                                <div class="col-md-12 mb-3" id="selectedUserCard" style="display: none;">
                                    <div class="card border-primary">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center justify-content-between">
                                                <div class="d-flex align-items-center">
                                                    <img id="selectedUserPhoto" src="" alt="User" class="rounded-circle me-3" style="width: 50px; height: 50px; object-fit: cover;">
                                                    <div>
                                                        <h6 class="mb-0" id="selectedUserName"></h6>
                                                        <small class="text-muted" id="selectedUserPhone"></small>
                                                    </div>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearSelectedUser()">
                                                    <i class="fas fa-times me-1"></i>Cancel
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-12 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-coins me-2"></i>Amount to Transfer
                                    </label>
                                    <input 
                                        type="number" 
                                        class="form-control" 
                                        id="transferAmount" 
                                        placeholder="Enter amount" 
                                        min="1"
                                        required>
                                    <small class="text-muted">Minimum: 1 credit</small>
                                </div>

                                <div class="col-md-12 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-comment me-2"></i>Description (Optional)
                                    </label>
                                    <textarea 
                                        class="form-control" 
                                        id="transferDescription" 
                                        rows="2" 
                                        placeholder="Add a note about this transfer"></textarea>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary btn-lg w-100" id="transferBtn">
                                <i class="fas fa-paper-plane me-2"></i>Transfer Credits
                            </button>
                        </form>

                        <hr class="my-4">

                        <h5 class="mb-3">
                            <i class="fas fa-clock me-2"></i>Recent Transfers
                        </h5>
                        <div id="recentTransfers">
                            <p class="text-muted text-center">No recent transfers</p>
                        </div>
                    </div>
                </div>

                <!-- Security Tab -->
                <div class="tab-pane fade" id="securityTab">
                    <div class="info-card">
                        <h4 class="mb-4">
                            <i class="fas fa-lock me-2"></i>Security Settings
                        </h4>
                        
                        <div class="mb-4">
                            <h5>Change Password</h5>
                            <p class="text-muted">Update your password to keep your account secure</p>
                            
                            <form id="passwordForm">
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label">Current Password</label>
                                        <input type="password" class="form-control" id="currentPassword" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">New Password</label>
                                        <input type="password" class="form-control" id="newPassword" required minlength="6">
                                        <small class="text-muted">Minimum 6 characters</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Confirm New Password</label>
                                        <input type="password" class="form-control" id="confirmPassword" required>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-key me-2"></i>Update Password
                                </button>
                            </form>
                        </div>

                        <hr>

                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Security Tip:</strong> Never share your password with anyone. Instantly Cards will never ask for your password via email or phone.
                        </div>
                    </div>
                </div>

                <!-- Documents Tab -->
                <div class="tab-pane fade" id="documentsTab">
                    <div class="info-card">
                        <h4 class="mb-4">
                            <i class="fas fa-file-upload me-2"></i>Identity Documents
                        </h4>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Document upload is optional but recommended for verification purposes.
                        </div>

                        <div class="row">
                            <!-- PAN Card Upload -->
                            <div class="col-md-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <i class="fas fa-id-card me-2 text-primary"></i>PAN Card
                                        </h5>
                                        <p class="text-muted small">Upload a clear image of your PAN card</p>
                                        
                                        <div class="text-center mb-3" id="panPreviewContainer">
                                            <img id="panPreview" src="" alt="PAN Card" class="img-fluid rounded border" style="max-height: 200px; display: none;">
                                            <div id="panPlaceholder" class="border rounded p-4 bg-light">
                                                <i class="fas fa-id-card fa-3x text-muted mb-2"></i>
                                                <p class="text-muted mb-0">No PAN card uploaded</p>
                                            </div>
                                        </div>
                                        
                                        <div class="d-grid gap-2">
                                            <label for="panUpload" class="btn btn-outline-primary">
                                                <i class="fas fa-upload me-2"></i>
                                                <span id="panUploadText">Upload PAN Card</span>
                                            </label>
                                            <input type="file" id="panUpload" accept="image/*" style="display: none;">
                                            <button class="btn btn-sm btn-outline-danger d-none" id="removePanBtn" onclick="removeDocument('pan')">
                                                <i class="fas fa-trash me-2"></i>Remove
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Aadhaar Card Upload -->
                            <div class="col-md-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <i class="fas fa-address-card me-2 text-success"></i>Aadhaar Card
                                        </h5>
                                        <p class="text-muted small">Upload a clear image of your Aadhaar card</p>
                                        
                                        <div class="text-center mb-3" id="aadhaarPreviewContainer">
                                            <img id="aadhaarPreview" src="" alt="Aadhaar Card" class="img-fluid rounded border" style="max-height: 200px; display: none;">
                                            <div id="aadhaarPlaceholder" class="border rounded p-4 bg-light">
                                                <i class="fas fa-address-card fa-3x text-muted mb-2"></i>
                                                <p class="text-muted mb-0">No Aadhaar card uploaded</p>
                                            </div>
                                        </div>
                                        
                                        <div class="d-grid gap-2">
                                            <label for="aadhaarUpload" class="btn btn-outline-success">
                                                <i class="fas fa-upload me-2"></i>
                                                <span id="aadhaarUploadText">Upload Aadhaar Card</span>
                                            </label>
                                            <input type="file" id="aadhaarUpload" accept="image/*" style="display: none;">
                                            <button class="btn btn-sm btn-outline-danger d-none" id="removeAadhaarBtn" onclick="removeDocument('aadhaar')">
                                                <i class="fas fa-trash me-2"></i>Remove
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-warning mt-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Privacy Note:</strong> Your documents are securely stored and only visible to administrators for verification purposes.
                        </div>
                    </div>
                </div>

                <!-- Advertisements Tab -->
                <div class="tab-pane fade" id="adsTab">
                    <div class="info-card">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4 class="mb-0">
                                <i class="fas fa-ad me-2"></i>My Advertisements
                            </h4>
                            <button class="btn btn-primary" onclick="showCreateAdModal()">
                                <i class="fas fa-plus me-2"></i>Create New Ad (1020 Credits)
                            </button>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>How it works:</strong> Create an ad for 1020 credits â†’ Admin reviews â†’ Appears in app after approval
                        </div>

                        <!-- My Ads Table -->
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Phone</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="myAdsTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Loading your ads...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Create/Edit Ad Modal -->
    <div class="modal fade" id="adModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="adModalTitle">Create New Advertisement</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="adForm">
                        <input type="hidden" id="adId">
                        
                        <div class="mb-3">
                            <label class="form-label">Advertisement Title *</label>
                            <input type="text" class="form-control" id="adTitle" required placeholder="e.g., Summer Sale 2024">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Phone Number * (for Call/Message buttons)</label>
                            <input type="tel" class="form-control" id="adPhone" required placeholder="+919876543210">
                            <small class="text-muted">Users will see Call/Message buttons with this number</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Bottom Banner Image * (624 Ã— 174px)</label>
                            <input type="file" class="form-control" id="adBottomImage" accept="image/*" required>
                            <div id="bottomImagePreview" class="mt-2" style="display: none;">
                                <img id="bottomImagePreviewImg" src="" class="img-fluid rounded border" style="max-height: 150px;">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Fullscreen Image (Optional) (624 Ã— 1000px)</label>
                            <input type="file" class="form-control" id="adFullscreenImage" accept="image/*">
                            <small class="text-muted">Shown when user taps the banner. If not provided, Call/Message buttons will appear.</small>
                            <div id="fullscreenImagePreview" class="mt-2" style="display: none;">
                                <img id="fullscreenImagePreviewImg" src="" class="img-fluid rounded border" style="max-height: 200px;">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Start Date *</label>
                                <input type="date" class="form-control" id="adStartDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">End Date *</label>
                                <input type="date" class="form-control" id="adEndDate" required>
                            </div>
                        </div>

                        <div class="alert alert-warning">
                            <i class="fas fa-coins me-2"></i>
                            <strong>Cost:</strong> 1020 credits will be deducted upon submission. Your ad will be reviewed by admin before appearing in the app.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitAd()">
                        <i class="fas fa-paper-plane me-2"></i>Submit Ad (1020 Credits)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:5000/api'
            : 'https://instantllychannelpatner.onrender.com/api';

        let authToken = localStorage.getItem('authToken');
        let currentUser = null;
        let currentApplication = null;  // Store user's approved application
        let isEditMode = false;

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', () => {
            if (!authToken) {
                // Show login section
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('profileSection').style.display = 'none';
                document.querySelector('.bg-light').style.display = 'none';
                return;
            }
            
            // Hide login, show profile
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('profileSection').style.display = 'block';
            document.querySelector('.bg-light').style.display = 'block';
            
            loadUserProfile();
            loadUserApplications();
            loadCreditsHistory();
            
            // Auto-refresh credits every 30 seconds
            setInterval(() => {
                if (authToken && currentUser) {
                    console.log('ðŸ”„ Auto-refreshing credits...');
                    fetchAndUpdateCredits();
                }
            }, 30000);
        });

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await handleLogin();
        });

        // Handle login
        async function handleLogin() {
            const phone = document.getElementById('loginPhone').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ phone, password })
                });

                const data = await response.json();

                if (response.ok) {
                    // Clear all cached data before storing new login
                    sessionStorage.clear();
                    
                    // Store token
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    currentUser = data.user;
                    
                    console.log('âœ… Login successful');
                    console.log('ðŸ”‘ Token stored:', authToken.substring(0, 30) + '...');
                    console.log('ðŸ‘¤ User:', currentUser.name, currentUser.phone);
                    console.log('ðŸ’° Credits:', currentUser.credits);

                    // Hide error
                    errorDiv.classList.add('d-none');

                    // Force reload with cache clear
                    window.location.reload(true);
                } else {
                    errorDiv.textContent = data.error || 'Login failed';
                    errorDiv.classList.remove('d-none');
                }
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'Network error. Please try again.';
                errorDiv.classList.remove('d-none');
            }
        }

        // Load user profile
        async function loadUserProfile() {
            try {
                // Add cache-busting parameter to force fresh data
                const cacheBuster = Date.now();
                const response = await fetch(`${API_BASE_URL}/auth/profile?_=${cacheBuster}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user || data; // Support both formats
                    
                    console.log('âœ… Profile loaded:', currentUser);
                    console.log('ðŸ’° Credits from API:', currentUser.credits);
                    console.log('ðŸ“… Credits expiry:', currentUser.creditsExpiryDate);
                    
                    // Check if credits are expired
                    if (currentUser.creditsExpiryDate) {
                        const expiryDate = new Date(currentUser.creditsExpiryDate);
                        const now = new Date();
                        const isExpired = now > expiryDate;
                        
                        if (isExpired) {
                            console.log('â° Credits expired on:', expiryDate.toLocaleDateString());
                        } else {
                            const daysLeft = Math.ceil((expiryDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));
                            console.log('âœ… Credits valid for', daysLeft, 'more days');
                        }
                    }
                    
                    // Store fresh data in sessionStorage for this session
                    sessionStorage.setItem('userProfile', JSON.stringify(currentUser));
                    
                    displayUserProfile(currentUser);
                    
                    // IMPORTANT: Fetch real-time credits from credits API
                    await fetchAndUpdateCredits();
                } else {
                    throw new Error('Failed to load profile');
                }
            } catch (error) {
                console.error('Profile load error:', error);
                showNotification('Failed to load profile. Please login again.', 'error');
                setTimeout(() => {
                    localStorage.removeItem('authToken');
                    window.location.href = 'index.html';
                }, 2000);
            }
        }

        // Fetch real-time credits from credits API
        async function fetchAndUpdateCredits() {
            try {
                console.log('ðŸ’° Fetching real-time credits from API...');
                const response = await fetch(`${API_BASE_URL}/credits/balance`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('âœ… Credits API response:', data);
                    
                    // Update credits in UI
                    const userCreditsEl = document.getElementById('userCredits');
                    if (userCreditsEl) {
                        userCreditsEl.textContent = (data.credits || 0).toLocaleString('en-IN');
                    }
                    
                    // Update in currentUser object
                    if (currentUser) {
                        currentUser.credits = data.credits || 0;
                        currentUser.creditsExpiryDate = data.creditsExpiryDate;
                        
                        // Store updated data
                        localStorage.setItem('currentUserCredits', currentUser.credits);
                        sessionStorage.setItem('userProfile', JSON.stringify(currentUser));
                    }
                    
                    // Log expiry info
                    if (data.isExpired) {
                        console.log('â° Credits are EXPIRED');
                    } else if (data.daysRemaining !== undefined) {
                        console.log(`âœ… Credits valid for ${data.daysRemaining} more days`);
                    }
                } else {
                    console.error('âŒ Failed to fetch credits:', response.status);
                }
            } catch (error) {
                console.error('âŒ Error fetching credits:', error);
            }
        }

        // Display user profile
        function displayUserProfile(user) {
            // Header
            const userNameEl = document.getElementById('userName');
            const userPhoneEl = document.getElementById('userPhone');
            const userEmailEl = document.getElementById('userEmail');
            const userCreditsEl = document.getElementById('userCredits');
            
            if (userNameEl) userNameEl.textContent = user.name;
            if (userPhoneEl) userPhoneEl.textContent = user.phone;
            if (userEmailEl) userEmailEl.textContent = user.email || 'Not provided';
            if (userCreditsEl) {
                userCreditsEl.textContent = (user.credits || 0).toLocaleString('en-IN');
                
                // Store credits in localStorage for cross-page sync
                localStorage.setItem('currentUserCredits', user.credits || 0);
                localStorage.setItem('currentUserName', user.name || '');
                localStorage.setItem('currentUserPhone', user.phone || '');
                
                console.log('ðŸ’° Profile credits updated:', user.credits);
            }

            // Stats
            const introducedCountEl = document.getElementById('introducedCount');
            if (introducedCountEl) introducedCountEl.textContent = user.introducedCount || 0;
            
            // Profile photo
            const profilePhoto = document.getElementById('profilePhoto');
            if (profilePhoto) {
                if (user.photo) {
                    profilePhoto.src = user.photo;
                } else {
                    profilePhoto.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDE1MCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxjaXJjbGUgY3g9Ijc1IiBjeT0iNzUiIHI9Ijc1IiBmaWxsPSIjZTJlOGYwIi8+Cjwvc3ZnPg==';
                }
            }

            // Form fields
            const editNameEl = document.getElementById('editName');
            const editPhoneEl = document.getElementById('editPhone');
            const editEmailEl = document.getElementById('editEmail');
            const editIntroducedByEl = document.getElementById('editIntroducedBy');
            
            if (editNameEl) editNameEl.value = user.name;
            if (editPhoneEl) editPhoneEl.value = user.phone;
            if (editEmailEl) editEmailEl.value = user.email || '';
            if (editIntroducedByEl) editIntroducedByEl.value = user.introducedBy || 'Self';

            // Credits date
            const creditsDateEl = document.getElementById('creditsDate');
            if (creditsDateEl && user.createdAt) {
                creditsDateEl.textContent = new Date(user.createdAt).toLocaleDateString();
            }
            
            // Load documents if available
            if (user.documents) {
                displayDocuments(user.documents);
            }
        }

        // Display documents
        function displayDocuments(documents) {
            // PAN Card
            if (documents.panCard) {
                document.getElementById('panPreview').src = documents.panCard;
                document.getElementById('panPreview').style.display = 'block';
                document.getElementById('panPlaceholder').style.display = 'none';
                document.getElementById('panUploadText').textContent = 'Change PAN Card';
                document.getElementById('removePanBtn').classList.remove('d-none');
            }
            
            // Aadhaar Card
            if (documents.aadhaarCard) {
                document.getElementById('aadhaarPreview').src = documents.aadhaarCard;
                document.getElementById('aadhaarPreview').style.display = 'block';
                document.getElementById('aadhaarPlaceholder').style.display = 'none';
                document.getElementById('aadhaarUploadText').textContent = 'Change Aadhaar Card';
                document.getElementById('removeAadhaarBtn').classList.remove('d-none');
            }
        }

        // Load user applications
        async function loadUserApplications() {
            try {
                // Use /me endpoint to get only current user's applications
                const response = await fetch(`${API_BASE_URL}/applications/me`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const applications = await response.json();
                    
                    // Store the approved application for later use
                    currentApplication = applications.find(app => app.status === 'approved');
                    
                    displayApplications(applications);
                    
                    // Update stats
                    const approved = applications.filter(app => app.status === 'approved').length;
                    document.getElementById('totalApplications').textContent = applications.length;
                    document.getElementById('approvedApplications').textContent = approved;
                } else {
                    document.getElementById('applicationsList').innerHTML = `
                        <p class="text-muted text-center">No applications found</p>
                    `;
                }
            } catch (error) {
                console.error('Applications load error:', error);
                document.getElementById('applicationsList').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Failed to load applications
                    </div>
                `;
            }
        }

        // Load credits history
        async function loadCreditsHistory() {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/profile`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const user = data.user;
                    console.log('ðŸ“Š Credits History:', user.creditsHistory);
                    console.log('ðŸ’° Total Credits:', user.credits);
                    displayCreditsHistory(user.creditsHistory || [], user.approvedDate || user.createdAt);
                } else {
                    console.error('Failed to load credits history');
                }
            } catch (error) {
                console.error('Credits history load error:', error);
            }
        }

        // Display credits history
        function displayCreditsHistory(history, userCreatedDate) {
            const container = document.getElementById('creditsHistory');
            
            if (!history || history.length === 0) {
                // Show default initial credits message
                container.innerHTML = `
                    <div class="list-group">
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-plus-circle text-success me-2"></i>
                                    <strong>Initial Credits Granted</strong>
                                    <br>
                                    <small class="text-muted">Welcome bonus on first approval</small>
                                </div>
                                <div class="text-end">
                                    <h5 class="mb-0 text-success">+5,00,000</h5>
                                    <small class="text-muted">${new Date(userCreatedDate).toLocaleDateString()}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // Sort by date (newest first)
            const sortedHistory = [...history].sort((a, b) => new Date(b.date) - new Date(a.date));

            container.innerHTML = `
                <div class="list-group">
                    ${sortedHistory.map(entry => {
                        const typeIcons = {
                            'initial': 'plus-circle',
                            'referral': 'users',
                            'purchase': 'shopping-cart',
                            'deduction': 'minus-circle',
                            'bonus': 'gift'
                        };
                        
                        const typeColors = {
                            'initial': 'success',
                            'referral': 'info',
                            'purchase': 'primary',
                            'deduction': 'danger',
                            'bonus': 'warning'
                        };
                        
                        const icon = typeIcons[entry.type] || 'circle';
                        const color = typeColors[entry.type] || 'secondary';
                        const sign = entry.amount > 0 ? '+' : '';
                        
                        return `
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-${icon} text-${color} me-2"></i>
                                        <strong>${entry.description}</strong>
                                        <br>
                                        <small class="text-muted">
                                            ${entry.type === 'referral' && entry.referredUser ? 
                                                `Referred: ${entry.referredUser}` : 
                                                entry.type.charAt(0).toUpperCase() + entry.type.slice(1) + ' credits'}
                                        </small>
                                    </div>
                                    <div class="text-end">
                                        <h5 class="mb-0 text-${color}">${sign}${entry.amount}</h5>
                                        <small class="text-muted">${new Date(entry.date).toLocaleDateString()}</small>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Display applications
        function displayApplications(applications) {
            const container = document.getElementById('applicationsList');
            
            if (!container) {
                console.error('applicationsList container not found');
                return;
            }
            
            if (applications.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                        <h5 class="text-muted">No applications yet</h5>
                        <p class="text-muted">Go to the positions page to apply for a position</p>
                        <a href="index.html#positions" class="btn btn-primary">
                            <i class="fas fa-search me-2"></i>Browse Positions
                        </a>
                    </div>
                `;
                return;
            }

            container.innerHTML = applications.map(app => {
                const statusClass = app.status === 'approved' ? 'success' : 
                                  app.status === 'rejected' ? 'danger' : 'warning';
                const statusIcon = app.status === 'approved' ? 'check-circle' : 
                                 app.status === 'rejected' ? 'times-circle' : 'clock';

                return `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h5 class="mb-2">${app.positionId.replace('pos_', '').replace(/-/g, ' ').replace(/_/g, ' - ')}</h5>
                                    <p class="mb-1">
                                        <i class="fas fa-calendar me-2"></i>
                                        Applied: ${new Date(app.appliedDate).toLocaleDateString()}
                                    </p>
                                    ${app.approvedDate ? `
                                        <p class="mb-0">
                                            <i class="fas fa-check me-2"></i>
                                            Approved: ${new Date(app.approvedDate).toLocaleDateString()}
                                        </p>
                                    ` : ''}
                                </div>
                                <div class="col-md-4 text-end">
                                    <span class="badge bg-${statusClass} fs-6">
                                        <i class="fas fa-${statusIcon} me-1"></i>
                                        ${app.status.charAt(0).toUpperCase() + app.status.slice(1)}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle edit mode
        function toggleEditMode() {
            isEditMode = true;
            document.getElementById('editName').removeAttribute('readonly');
            document.getElementById('editEmail').removeAttribute('readonly');
            document.getElementById('profileForm').classList.add('edit-mode');
            document.getElementById('profileActions').classList.remove('d-none');
            document.getElementById('editProfileBtn').classList.add('d-none');
        }

        // Cancel edit mode
        function cancelEditMode() {
            isEditMode = false;
            document.getElementById('editName').setAttribute('readonly', true);
            document.getElementById('editEmail').setAttribute('readonly', true);
            document.getElementById('profileForm').classList.remove('edit-mode');
            document.getElementById('profileActions').classList.add('d-none');
            document.getElementById('editProfileBtn').classList.remove('d-none');
            
            // Reset values
            displayUserProfile(currentUser);
        }

        // Profile form submit
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('editName').value;
            const email = document.getElementById('editEmail').value;

            try {
                const response = await fetch(`${API_BASE_URL}/auth/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ name, email })
                });

                if (response.ok) {
                    showNotification('Profile updated successfully!', 'success');
                    cancelEditMode();
                    loadUserProfile();
                } else {
                    const data = await response.json();
                    showNotification(data.error || 'Failed to update profile', 'error');
                }
            } catch (error) {
                console.error('Profile update error:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        });

        // Password form submit
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                showNotification('Passwords do not match', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/auth/change-password`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        currentPassword,
                        newPassword
                    })
                });

                if (response.ok) {
                    showNotification('Password changed successfully!', 'success');
                    document.getElementById('passwordForm').reset();
                } else {
                    const data = await response.json();
                    showNotification(data.error || 'Failed to change password', 'error');
                }
            } catch (error) {
                console.error('Password change error:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        });

        // Photo upload
        document.getElementById('photoUpload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Check file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showNotification('Photo size must be less than 2MB', 'error');
                return;
            }

            // Convert to base64
            const reader = new FileReader();
            reader.onload = async (event) => {
                const photoBase64 = event.target.result;

                try {
                    const response = await fetch(`${API_BASE_URL}/auth/profile`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({ photo: photoBase64 })
                    });

                    if (response.ok) {
                        document.getElementById('profilePhoto').src = photoBase64;
                        showNotification('Photo updated successfully!', 'success');
                        loadUserProfile();
                    } else {
                        showNotification('Failed to upload photo', 'error');
                    }
                } catch (error) {
                    console.error('Photo upload error:', error);
                    showNotification('Network error. Please try again.', 'error');
                }
            };
            reader.readAsDataURL(file);
        });

        // PAN Card upload
        document.getElementById('panUpload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Check file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showNotification('Document size must be less than 2MB', 'error');
                return;
            }

            // Convert to base64
            const reader = new FileReader();
            reader.onload = async (event) => {
                const panBase64 = event.target.result;

                try {
                    const response = await fetch(`${API_BASE_URL}/auth/profile`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({ panCard: panBase64 })
                    });

                    if (response.ok) {
                        document.getElementById('panPreview').src = panBase64;
                        document.getElementById('panPreview').style.display = 'block';
                        document.getElementById('panPlaceholder').style.display = 'none';
                        document.getElementById('panUploadText').textContent = 'Change PAN Card';
                        document.getElementById('removePanBtn').classList.remove('d-none');
                        showNotification('PAN Card uploaded successfully!', 'success');
                        loadUserProfile();
                    } else {
                        showNotification('Failed to upload PAN card', 'error');
                    }
                } catch (error) {
                    console.error('PAN upload error:', error);
                    showNotification('Network error. Please try again.', 'error');
                }
            };
            reader.readAsDataURL(file);
        });

        // Aadhaar Card upload
        document.getElementById('aadhaarUpload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Check file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showNotification('Document size must be less than 2MB', 'error');
                return;
            }

            // Convert to base64
            const reader = new FileReader();
            reader.onload = async (event) => {
                const aadhaarBase64 = event.target.result;

                try {
                    const response = await fetch(`${API_BASE_URL}/auth/profile`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({ aadhaarCard: aadhaarBase64 })
                    });

                    if (response.ok) {
                        document.getElementById('aadhaarPreview').src = aadhaarBase64;
                        document.getElementById('aadhaarPreview').style.display = 'block';
                        document.getElementById('aadhaarPlaceholder').style.display = 'none';
                        document.getElementById('aadhaarUploadText').textContent = 'Change Aadhaar Card';
                        document.getElementById('removeAadhaarBtn').classList.remove('d-none');
                        showNotification('Aadhaar Card uploaded successfully!', 'success');
                        loadUserProfile();
                    } else {
                        showNotification('Failed to upload Aadhaar card', 'error');
                    }
                } catch (error) {
                    console.error('Aadhaar upload error:', error);
                    showNotification('Network error. Please try again.', 'error');
                }
            };
            reader.readAsDataURL(file);
        });

        // Remove document function
        async function removeDocument(type) {
            const confirmDelete = confirm(`Are you sure you want to remove your ${type === 'pan' ? 'PAN' : 'Aadhaar'} card?`);
            if (!confirmDelete) return;

            try {
                const body = type === 'pan' ? { panCard: '' } : { aadhaarCard: '' };
                
                const response = await fetch(`${API_BASE_URL}/auth/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(body)
                });

                if (response.ok) {
                    if (type === 'pan') {
                        document.getElementById('panPreview').style.display = 'none';
                        document.getElementById('panPlaceholder').style.display = 'block';
                        document.getElementById('panUploadText').textContent = 'Upload PAN Card';
                        document.getElementById('removePanBtn').classList.add('d-none');
                        document.getElementById('panUpload').value = '';
                    } else {
                        document.getElementById('aadhaarPreview').style.display = 'none';
                        document.getElementById('aadhaarPlaceholder').style.display = 'block';
                        document.getElementById('aadhaarUploadText').textContent = 'Upload Aadhaar Card';
                        document.getElementById('removeAadhaarBtn').classList.add('d-none');
                        document.getElementById('aadhaarUpload').value = '';
                    }
                    showNotification(`${type === 'pan' ? 'PAN' : 'Aadhaar'} card removed successfully!`, 'success');
                    loadUserProfile();
                } else {
                    showNotification('Failed to remove document', 'error');
                }
            } catch (error) {
                console.error('Document removal error:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        // Parse location from positionId
        function parseLocationFromPositionId(positionId) {
            if (!positionId) return {};
            
            // Position ID format: pos_<role>_<country>_<location_parts>
            // Examples:
            // pos_district-head_india_mumbai
            // pos_zone-head_india_west
            // pos_state-head_india_maharashtra
            
            const parts = positionId.split('_');
            if (parts.length < 3) return {};
            
            const role = parts[1]; // district-head, zone-head, etc.
            const country = parts[2]; // india
            const locationPart = parts.slice(3).join('_'); // mumbai, west, maharashtra, etc.
            
            const location = {
                country: country.charAt(0).toUpperCase() + country.slice(1)
            };
            
            // Parse based on role
            if (role.includes('district-head')) {
                location.district = locationPart.toUpperCase();
                // For Mumbai district, we know the details
                if (locationPart === 'mumbai') {
                    location.zone = 'Western';
                    location.state = 'MAHARASHTRA';
                    location.division = 'South Mumbai';
                }
            } else if (role.includes('zone-head')) {
                location.zone = locationPart.charAt(0).toUpperCase() + locationPart.slice(1);
            } else if (role.includes('state-head')) {
                location.state = locationPart.toUpperCase();
            } else if (role.includes('division-head') || role.includes('tehsil-head')) {
                location.division = locationPart.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
            }
            
            return location;
        }

        // Go to promotions page with user data
        function goToPromotions() {
            if (!currentUser) {
                alert('Please wait while we load your profile data');
                return;
            }
            
            // Get location from application if available, otherwise parse from positionId
            let location = currentApplication?.location || {};
            
            // If location is empty, try to parse from positionId
            if (!location.zone && !location.state && !location.district) {
                const positionId = currentApplication?.positionId || currentUser.positionId;
                location = parseLocationFromPositionId(positionId);
            }
            
            console.log('ðŸ“ Current Application:', currentApplication);
            console.log('ðŸ“ Location Data:', location);
            console.log('ðŸ“ Position ID:', currentApplication?.positionId || currentUser.positionId);
            
            // Store promotion data in sessionStorage (NOT in URL - photos are too large and cause URI_TOO_LONG error)
            const promotionData = {
                userId: currentUser._id || '',
                name: currentUser.name || '',
                phone: currentUser.phone || '',
                photo: currentUser.photo || '',
                country: location.country || 'India',
                zone: location.zone || '',
                state: location.state || '',
                division: location.division || '',
                district: location.district || '',
                designation: currentApplication?.positionId || currentUser.positionId || ''
            };
            
            console.log('ðŸ“¦ Storing promotion data in sessionStorage:', promotionData);
            sessionStorage.setItem('promotionData', JSON.stringify(promotionData));
            
            window.location.href = 'promotion.html';
        }

        // Logout
        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = 'index.html';
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;

            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '9999';
                document.body.appendChild(toastContainer);
            }

            const toastElement = document.createElement('div');
            toastElement.innerHTML = toastHtml;
            const actualToast = toastElement.firstElementChild;
            toastContainer.appendChild(actualToast);

            const toast = new bootstrap.Toast(actualToast, {
                autohide: true,
                delay: 3000
            });
            toast.show();

            actualToast.addEventListener('hidden.bs.toast', () => {
                actualToast.remove();
            });
        }

        // =============== CREDITS TRANSFER FUNCTIONALITY ===============
        let selectedUser = null;
        let searchTimeout = null;

        // Phone number input listener for user search
        document.getElementById('transferPhone').addEventListener('input', async (e) => {
            const phonePrefix = e.target.value.trim();
            
            // Clear previous timeout
            if (searchTimeout) clearTimeout(searchTimeout);
            
            // Hide dropdown if input is empty or too short
            if (phonePrefix.length < 2) {
                document.getElementById('userDropdown').style.display = 'none';
                return;
            }

            // Debounce search
            searchTimeout = setTimeout(async () => {
                await searchUsers(phonePrefix);
            }, 200);
        });

        async function searchUsers(phonePrefix) {
            try {
                const response = await fetch(`${API_BASE_URL}/credits/search-users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ phonePrefix })
                });

                const data = await response.json();
                
                if (data.success && data.users.length > 0) {
                    displayUserDropdown(data.users);
                } else {
                    document.getElementById('userDropdown').innerHTML = `
                        <div class="list-group-item text-center text-muted">
                            <i class="fas fa-search me-2"></i>No users found
                        </div>
                    `;
                    document.getElementById('userDropdown').style.display = 'block';
                }
            } catch (error) {
                console.error('User search error:', error);
                showNotification('Failed to search users', 'error');
            }
        }

        function displayUserDropdown(users) {
            const dropdown = document.getElementById('userDropdown');
            dropdown.innerHTML = users.map(user => `
                <button type="button" class="list-group-item list-group-item-action" onclick='selectUser(${JSON.stringify(user)})'>
                    <div class="d-flex align-items-center">
                        <img src="${user.profilePicture || 'images/default-avatar.png'}" 
                             class="rounded-circle me-3" 
                             style="width: 40px; height: 40px; object-fit: cover;"
                             onerror="this.src='images/default-avatar.png'">
                        <div>
                            <div class="fw-bold">${user.name}</div>
                            <small class="text-muted">${user.displayPhone}</small>
                        </div>
                    </div>
                </button>
            `).join('');
            dropdown.style.display = 'block';
        }

        function selectUser(user) {
            selectedUser = user;
            
            // Hide dropdown
            document.getElementById('userDropdown').style.display = 'none';
            
            // Clear phone input
            document.getElementById('transferPhone').value = '';
            
            // Show selected user card
            document.getElementById('selectedUserCard').style.display = 'block';
            document.getElementById('selectedUserPhoto').src = user.profilePicture || 'images/default-avatar.png';
            document.getElementById('selectedUserName').textContent = user.name;
            document.getElementById('selectedUserPhone').textContent = user.phone;
        }

        function clearSelectedUser() {
            selectedUser = null;
            document.getElementById('selectedUserCard').style.display = 'none';
            document.getElementById('transferPhone').value = '';
        }

        async function handleTransferCredits(event) {
            event.preventDefault();
            
            if (!selectedUser) {
                showNotification('Please select a recipient', 'error');
                return;
            }

            const amount = parseInt(document.getElementById('transferAmount').value);
            const description = document.getElementById('transferDescription').value;

            if (amount <= 0) {
                showNotification('Amount must be greater than 0', 'error');
                return;
            }

            // Disable button
            const btn = document.getElementById('transferBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';

            try {
                const response = await fetch(`${API_BASE_URL}/credits/transfer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        toUserId: selectedUser._id,
                        amount: amount,
                        description: description
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification(`Successfully transferred ${amount} credits to ${selectedUser.name}`, 'success');
                    
                    // Reset form
                    document.getElementById('transferForm').reset();
                    clearSelectedUser();
                    
                    // Reload data
                    await loadUserProfile();
                    await loadRecentTransfers();
                } else {
                    showNotification(data.message || 'Transfer failed', 'error');
                }
            } catch (error) {
                console.error('Transfer error:', error);
                showNotification('Network error. Please try again.', 'error');
            } finally {
                // Re-enable button
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Transfer Credits';
            }
        }

        async function loadRecentTransfers() {
            try {
                const response = await fetch(`${API_BASE_URL}/credits/transactions?limit=5`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();

                if (data.success && data.transactions.length > 0) {
                    const container = document.getElementById('recentTransfers');
                    container.innerHTML = data.transactions.map(t => {
                        const isReceived = t.type === 'transfer_received';
                        const isSent = t.type === 'transfer_sent';
                        
                        if (!isReceived && !isSent) return '';

                        const otherUser = isReceived ? t.fromUser : t.toUser;
                        const icon = isReceived ? 'arrow-down' : 'arrow-up';
                        const colorClass = isReceived ? 'success' : 'danger';
                        const sign = isReceived ? '+' : '-';

                        return `
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-${icon} text-${colorClass} me-2"></i>
                                        <strong>${t.description}</strong>
                                        <br>
                                        <small class="text-muted">${otherUser?.name || 'Unknown'} - ${new Date(t.createdAt).toLocaleString()}</small>
                                    </div>
                                    <div class="text-end">
                                        <h6 class="mb-0 text-${colorClass}">${sign}${t.amount}</h6>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    document.getElementById('recentTransfers').innerHTML = 
                        '<p class="text-muted text-center">No recent transfers</p>';
                }
            } catch (error) {
                console.error('Load transfers error:', error);
            }
        }

        // Load recent transfers when transfer tab is shown
        document.querySelector('[data-bs-target="#transferTab"]').addEventListener('click', () => {
            loadRecentTransfers();
            // Update available credits display
            const credits = document.getElementById('userCredits')?.textContent || '0';
            document.getElementById('transferAvailableCredits').textContent = credits;
        });

        // Password visibility toggle for login form
        const toggleLoginPassword = document.getElementById('toggleLoginPassword');
        const loginPasswordInput = document.getElementById('loginPassword');
        const toggleLoginPasswordIcon = document.getElementById('toggleLoginPasswordIcon');

        if (toggleLoginPassword) {
            toggleLoginPassword.addEventListener('click', function() {
                const type = loginPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                loginPasswordInput.setAttribute('type', type);
                toggleLoginPasswordIcon.classList.toggle('fa-eye');
                toggleLoginPasswordIcon.classList.toggle('fa-eye-slash');
            });
        }

        // ============================================
        // ADS MANAGEMENT SYSTEM
        // ============================================

        let currentEditingAdId = null;

        // Load user's ads when ads tab is shown
        document.querySelector('[data-bs-target="#adsTab"]').addEventListener('click', () => {
            loadMyAds();
        });

        // Image preview handlers
        document.getElementById('adBottomImage').addEventListener('change', function(e) {
            previewImage(e.target.files[0], 'bottomImagePreview', 'bottomImagePreviewImg');
        });

        document.getElementById('adFullscreenImage').addEventListener('change', function(e) {
            previewImage(e.target.files[0], 'fullscreenImagePreview', 'fullscreenImagePreviewImg');
        });

        function previewImage(file, previewDivId, previewImgId) {
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById(previewImgId).src = e.target.result;
                    document.getElementById(previewDivId).style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function showCreateAdModal() {
            currentEditingAdId = null;
            document.getElementById('adModalTitle').textContent = 'Create New Advertisement';
            document.getElementById('adForm').reset();
            document.getElementById('bottomImagePreview').style.display = 'none';
            document.getElementById('fullscreenImagePreview').style.display = 'none';
            document.getElementById('adBottomImage').required = true;
            
            const modal = new bootstrap.Modal(document.getElementById('adModal'));
            modal.show();
        }

        async function loadMyAds() {
            const tbody = document.getElementById('myAdsTableBody');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>Loading...</td></tr>';

            try {
                // Use main Instantlly Cards backend for ads
                const MAIN_BACKEND_URL = 'https://instantlly-cards-backend-6ki0.onrender.com/api';
                const response = await fetch(`${MAIN_BACKEND_URL}/channel-partner/ads`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();

                if (data.ads && data.ads.length > 0) {
                    tbody.innerHTML = data.ads.map(ad => {
                        const statusBadge = getStatusBadge(ad.status);
                        const startDate = new Date(ad.startDate).toLocaleDateString();
                        const endDate = new Date(ad.endDate).toLocaleDateString();
                        
                        return `
                            <tr>
                                <td>${ad.title}</td>
                                <td>${ad.phoneNumber}</td>
                                <td>${startDate}</td>
                                <td>${endDate}</td>
                                <td>${statusBadge}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="editAd('${ad.id}')" ${ad.status === 'rejected' ? '' : 'disabled'}>
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No ads yet. Create your first ad!</td></tr>';
                }
            } catch (error) {
                console.error('Load ads error:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading ads</td></tr>';
            }
        }

        function getStatusBadge(status) {
            const badges = {
                'pending': '<span class="badge bg-warning text-dark"><i class="fas fa-clock me-1"></i>Pending Review</span>',
                'approved': '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Approved</span>',
                'rejected': '<span class="badge bg-danger"><i class="fas fa-times me-1"></i>Rejected</span>'
            };
            return badges[status] || '<span class="badge bg-secondary">Unknown</span>';
        }

        async function submitAd() {
            const title = document.getElementById('adTitle').value;
            const phone = document.getElementById('adPhone').value;
            const startDate = document.getElementById('adStartDate').value;
            const endDate = document.getElementById('adEndDate').value;
            const bottomImageFile = document.getElementById('adBottomImage').files[0];
            const fullscreenImageFile = document.getElementById('adFullscreenImage').files[0];

            // Validation
            if (!title || !phone || !startDate || !endDate) {
                showNotification('Please fill all required fields', 'error');
                return;
            }

            if (!currentEditingAdId && !bottomImageFile) {
                showNotification('Bottom banner image is required', 'error');
                return;
            }

            // Check credits
            const currentCredits = parseInt(document.getElementById('userCredits')?.textContent || '0');
            if (!currentEditingAdId && currentCredits < 1020) {
                showNotification('Insufficient credits. You need 1020 credits to create an ad.', 'error');
                return;
            }

            // Create FormData
            const formData = new FormData();
            formData.append('title', title);
            formData.append('phoneNumber', phone);
            formData.append('startDate', startDate);
            formData.append('endDate', endDate);
            formData.append('uploaderName', currentUser?.name || 'Channel Partner');
            
            if (bottomImageFile) {
                formData.append('images', bottomImageFile);
            }
            if (fullscreenImageFile) {
                formData.append('images', fullscreenImageFile);
            }

            // Show loading
            const modalElement = document.getElementById('adModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            const submitBtn = modalElement.querySelector('.btn-primary');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';

            try {
                // Use main Instantlly Cards backend for ads
                const MAIN_BACKEND_URL = 'https://instantlly-cards-backend-6ki0.onrender.com/api';
                const response = await fetch(`${MAIN_BACKEND_URL}/channel-partner/ads`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    showNotification('Ad submitted successfully! Awaiting admin approval.', 'success');
                    modal.hide();
                    loadMyAds();
                    loadUserProfile(); // Refresh credits
                } else {
                    showNotification(data.message || 'Failed to submit ad', 'error');
                }
            } catch (error) {
                console.error('Submit ad error:', error);
                showNotification('Network error. Please try again.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Submit Ad (1020 Credits)';
            }
        }

        async function editAd(adId) {
            // TODO: Implement edit functionality
            // For now, show message
            showNotification('Edit functionality coming soon! Rejected ads can be resubmitted.', 'info');
        }
    </script>
</body>
</html>
