<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Promotion Cards - InstantllyCards</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .promotion-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.25rem 0;
            margin-bottom: 1.5rem;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        }
        
        .promotion-header h1 {
            font-size: 1.75rem;
            margin-bottom: 0;
        }
        
        .welcome-banner {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-left: 4px solid #ff6b6b;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .welcome-banner h5 {
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }
        
        .welcome-banner p {
            font-size: 0.875rem;
            margin-bottom: 0;
            margin-top: 0.25rem !important;
        }
        
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .table thead th {
            border: none;
            padding: 0.6rem 0.5rem;
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
            font-size: 0.85rem;
        }
        
        .table tbody td {
            vertical-align: middle;
            text-align: center;
            padding: 0.6rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .download-btn {
            border: 1.5px solid #10b981;
            background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
            color: #047857;
            font-weight: 600;
            padding: 0.15rem 0.35rem;
            border-radius: 5px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
            font-size: 0.65rem;
            cursor: pointer;
        }
        
        .download-btn i {
            font-size: 0.6rem;
        }
        
        .download-btn img {
            width: 30px;
            height: 30px;
            object-fit: cover;
            border-radius: 3px;
        }
        
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
            background: linear-gradient(135deg, #96e6a1 0%, #d4fc79 100%);
        }
        
        .download-btn-disabled {
            border: 1.5px solid #d1d5db;
            background: #f3f4f6;
            color: #9ca3af;
            font-weight: 600;
            padding: 0.15rem 0.35rem;
            border-radius: 5px;
            cursor: not-allowed;
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
            opacity: 0.6;
            font-size: 0.65rem;
        }
        
        .download-btn-disabled i {
            font-size: 0.6rem;
        }
        
        /* Modal Styles */
        .modal-preview-img {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
        }
        
        .modal-body {
            text-align: center;
        }
        
        .back-btn {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 0.5rem 1.25rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .back-btn:hover {
            background: #667eea;
            color: white;
            transform: translateX(-5px);
        }
        
        .user-info {
            background: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        
        .user-info img {
            width: 50px !important;
            height: 50px !important;
        }
        
        .user-info h5 {
            font-size: 1rem;
            margin-bottom: 0;
        }
        
        .user-info p {
            font-size: 0.875rem;
        }
        
        .loader {
            text-align: center;
            padding: 3rem;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>
<body>
    <div class="container py-3">
        <!-- Back Button -->
        <div class="mb-2">
            <button onclick="window.history.back()" class="back-btn">
                <i class="fas fa-arrow-left me-2"></i> Back
            </button>
        </div>
        
        <!-- Header -->
        <div class="promotion-header text-center">
            <h1 class="fw-bold mb-0">My Promotion Cards</h1>
        </div>
        
        <!-- Welcome Banner -->
        <div class="welcome-banner">
            <h5><i class="fas fa-hand-wave me-2"></i><strong>Welcome!</strong> Download your personalized promotion cards in different languages.</h5>
            <p class="mb-0 mt-2">Each row represents a promotion template upload date. Green buttons indicate available languages for that date.</p>
        </div>
        
        <!-- User Info (populated dynamically) -->
        <div class="user-info d-none" id="userInfoCard">
            <div class="row align-items-center">
                <div class="col-auto">
                    <img id="userPhoto" src="" alt="User Photo" class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;">
                </div>
                <div class="col">
                    <h5 class="mb-0" id="userName">-</h5>
                    <p class="mb-0 text-muted" id="userMobile">-</p>
                </div>
            </div>
        </div>
        
        <!-- Loading Spinner -->
        <div class="loader" id="loader">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading promotion cards...</p>
        </div>
        
        <!-- Promotions Table -->
        <div class="table-container d-none" id="promotionsTable">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Sr.No</th>
                            <th>Date</th>
                            <th>Hindi</th>
                            <th>English</th>
                            <th>Marathi</th>
                            <th>Gujarati</th>
                            <th>Tamil</th>
                            <th>Telugu</th>
                            <th>Kannada</th>
                            <th>Bengali</th>
                            <th>Odia</th>
                            <th>Urdu</th>
                        </tr>
                    </thead>
                    <tbody id="promotionsTableBody">
                        <!-- Rows will be populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- No Promotions Message -->
        <div class="alert alert-info text-center d-none" id="noPromotionsMsg">
            <i class="fas fa-info-circle fa-2x mb-3"></i>
            <h5>No Promotions Available Yet</h5>
            <p class="mb-0">Check back later for new promotion cards!</p>
        </div>
    </div>
    
    <!-- Image Preview Modal -->
    <div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-labelledby="imagePreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imagePreviewModalLabel">Promotion Card Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <img id="previewImage" src="" alt="Promotion Preview" class="modal-preview-img">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="confirmDownloadBtn">
                        <i class="fas fa-download me-2"></i>Download
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Canvas for generating promotion cards (hidden) -->
    <canvas id="promotionCanvas" style="display: none;"></canvas>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const API_BASE_URL = 'https://instantllychannelpatner.onrender.com/api';
        
        // Get user data from sessionStorage (NOT URL - prevents URI_TOO_LONG error)
        let promotionData;
        try {
            const storedData = sessionStorage.getItem('promotionData');
            if (!storedData) {
                console.error('❌ No promotion data found in sessionStorage');
                alert('Error: Promotion data not found. Please try again from profile page.');
                window.location.href = 'profile.html';
            }
            promotionData = JSON.parse(storedData);
            console.log('✅ Loaded promotion data from sessionStorage:', promotionData);
        } catch (error) {
            console.error('❌ Error loading promotion data:', error);
            alert('Error loading promotion data. Please try again.');
            window.location.href = 'profile.html';
        }
        
        const userId = promotionData.userId;
        const userName = promotionData.name || 'Member';
        const userPhone = promotionData.phone || '-';
        const userPhoto = promotionData.photo || '';
        const userCountry = promotionData.country || 'India';
        const userZone = promotionData.zone || '';
        const userState = promotionData.state || '';
        const userDivision = promotionData.division || '';
        const userDistrict = promotionData.district || '';
        const userDesignation = promotionData.designation || '';
        
        // Languages supported
        const languages = ['hindi', 'english', 'marathi', 'gujarati', 'tamil', 'telugu', 'kannada', 'bengali', 'odia', 'urdu'];
        const languageLabels = {
            'hindi': 'Hindi',
            'english': 'English',
            'marathi': 'Marathi',
            'gujarati': 'Gujarati',
            'tamil': 'Tamil',
            'telugu': 'Telugu',
            'kannada': 'Kannada',
            'bengali': 'Bengali',
            'odia': 'Odia',
            'urdu': 'Urdu'
        };
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            // Display user info
            document.getElementById('userName').textContent = userName;
            document.getElementById('userMobile').textContent = userPhone;
            if (userPhoto) {
                document.getElementById('userPhoto').src = userPhoto;
            }
            document.getElementById('userInfoCard').classList.remove('d-none');
            
            // Load promotions
            loadPromotions();
        });
        
        // Load promotions from backend
        async function loadPromotions() {
            try {
                const response = await fetch(`${API_BASE_URL}/promotions/user-promotions`);
                
                if (!response.ok) {
                    throw new Error('Failed to load promotions');
                }
                
                const data = await response.json();
                console.log('Promotions data:', data);
                
                // Hide loader
                document.getElementById('loader').classList.add('d-none');
                
                if (!data.promotions || data.promotions.length === 0) {
                    // Show no promotions message
                    document.getElementById('noPromotionsMsg').classList.remove('d-none');
                } else {
                    // Display promotions table
                    displayPromotions(data.promotions);
                    document.getElementById('promotionsTable').classList.remove('d-none');
                }
            } catch (error) {
                console.error('Error loading promotions:', error);
                document.getElementById('loader').classList.add('d-none');
                document.getElementById('noPromotionsMsg').classList.remove('d-none');
                document.getElementById('noPromotionsMsg').innerHTML = `
                    <i class="fas fa-exclamation-triangle fa-2x mb-3 text-warning"></i>
                    <h5>Error Loading Promotions</h5>
                    <p class="mb-0">Please try again later.</p>
                `;
            }
        }
        
        // Display promotions in table
        function displayPromotions(promotions) {
            const tbody = document.getElementById('promotionsTableBody');
            tbody.innerHTML = '';
            
            // Sort by date (newest first)
            promotions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            promotions.forEach((promo, index) => {
                const row = document.createElement('tr');
                
                // Format date as DD/MM/YY
                const date = new Date(promo.date);
                const formattedDate = `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getFullYear()).slice(-2)}`;
                
                let rowHTML = `
                    <td><strong>${index + 1}</strong></td>
                    <td><strong>${formattedDate}</strong></td>
                `;
                
                // Add download buttons for each language
                languages.forEach(lang => {
                    if (promo.languages && promo.languages.includes(lang)) {
                        // Available - show image preview button
                        rowHTML += `
                            <td>
                                <button class="download-btn" onclick="showImagePreview(event, '${promo._id}', '${lang}', '${formattedDate}')">
                                    <img src="${API_BASE_URL}/promotions/image/${promo._id}/${lang}" alt="${languageLabels[lang]}" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                                    <i class="fas fa-image" style="display:none;"></i>
                                </button>
                            </td>
                        `;
                    } else {
                        // Not available - show disabled button
                        rowHTML += `
                            <td>
                                <button class="download-btn-disabled" disabled>
                                    <i class="fas fa-times"></i>
                                </button>
                            </td>
                        `;
                    }
                });
                
                row.innerHTML = rowHTML;
                tbody.appendChild(row);
            });
        }
        
        // Global variables for modal
        let currentPromotionData = {};
        let currentPreviewDataUrl = null;
        
        // Show image preview in modal
        async function showImagePreview(event, promotionId, language, date) {
            event.preventDefault();
            
            // Store current promotion data
            currentPromotionData = { promotionId, language, date };
            
            // Show loading in preview
            const previewImage = document.getElementById('previewImage');
            previewImage.src = '';
            previewImage.alt = 'Generating preview...';
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('imagePreviewModal'));
            modal.show();
            
            try {
                // Fetch promotion image from backend
                const response = await fetch(`${API_BASE_URL}/promotions/image/${promotionId}/${language}`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch promotion image');
                }
                
                const blob = await response.blob();
                const promotionImageUrl = URL.createObjectURL(blob);
                
                // Generate complete card preview with user details
                const previewDataUrl = await generatePromotionCardPreview(promotionImageUrl, language, date);
                currentPreviewDataUrl = previewDataUrl;
                
                // Set preview image to the complete card
                previewImage.src = previewDataUrl;
                previewImage.alt = 'Promotion Card Preview';
                
            } catch (error) {
                console.error('Error generating preview:', error);
                previewImage.alt = 'Failed to load preview';
                alert('Failed to load preview. Please try again.');
            }
        }
        
        // Generate promotion card preview (same as download but returns data URL)
        async function generatePromotionCardPreview(promotionImageUrl, language, date) {
            return new Promise((resolve, reject) => {
                const canvas = document.getElementById('promotionCanvas');
                const ctx = canvas.getContext('2d');
                
                // Create promotion image element
                const promotionImg = new Image();
                promotionImg.crossOrigin = 'anonymous';
                
                promotionImg.onload = () => {
                    // Set canvas dimensions (1080x1920 pixels)
                    const canvasWidth = 1080;
                    const canvasHeight = 1920;
                    
                    canvas.width = canvasWidth;
                    canvas.height = canvasHeight;
                    
                    // Draw promotion image (85% - top portion)
                    const promoHeight = 1632; // 85% of 1920
                    ctx.drawImage(promotionImg, 0, 0, canvasWidth, promoHeight);
                    
                    // Draw user details section (15% - bottom portion)
                    const detailsStartY = promoHeight;
                    const detailsHeight = 288; // 15% of 1920
                    
                    // Background for user details
                    const gradient = ctx.createLinearGradient(0, detailsStartY, 0, detailsStartY + detailsHeight);
                    gradient.addColorStop(0, '#fef3c7');
                    gradient.addColorStop(1, '#fcd34d');
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, detailsStartY, canvasWidth, detailsHeight);
                    
                    // Function to draw user details (no logo)
                    const drawUserDetailsAndLogo = () => {
                        // Determine text starting position based on photo availability
                        const textStartX = userPhoto ? 250 : 60;
                        const textStartY = detailsStartY + 60;
                        
                        // Draw user details text with larger font sizes
                        ctx.fillStyle = '#7c2d12';
                        ctx.font = 'bold 52px Arial';
                        ctx.fillText(userName, textStartX, textStartY);
                        
                        ctx.font = 'bold 46px Arial';
                        ctx.fillText(userPhone, textStartX, textStartY + 65);
                        
                        // Build location path
                        let locationPath = '';
                        if (userCountry) locationPath += `Country: ${userCountry}`;
                        if (userZone) locationPath += ` Zone: ${userZone}`;
                        if (userState) locationPath += ` State: ${userState}`;
                        if (userDivision) locationPath += ` Div: ${userDivision}`;
                        if (userDistrict) locationPath += ` District: ${userDistrict}`;
                        
                        // Draw location path - may wrap to 2 lines if too long
                        if (locationPath) {
                            ctx.font = '36px Arial';
                            ctx.fillStyle = '#92400e';
                            const maxWidth = userPhoto ? 780 : 960;
                            const words = locationPath.split(' ');
                            let line = '';
                            let y = textStartY + 130;
                            
                            for (let word of words) {
                                let testLine = line + word + ' ';
                                let metrics = ctx.measureText(testLine);
                                if (metrics.width > maxWidth && line !== '') {
                                    ctx.fillText(line.trim(), textStartX, y);
                                    line = word + ' ';
                                    y += 45;
                                } else {
                                    line = testLine;
                                }
                            }
                            ctx.fillText(line.trim(), textStartX, y);
                        }
                        
                        // Draw designation in bold
                        if (userDesignation) {
                            ctx.font = 'bold 42px Arial';
                            ctx.fillStyle = '#7c2d12';
                            let desigY = locationPath ? textStartY + 215 : textStartY + 130;
                            ctx.fillText(`Designation: ${userDesignation}`, textStartX, desigY);
                        }
                        
                        // Return as data URL (no logo)
                        resolve(canvas.toDataURL('image/png'));
                    };
                    
                    // Check if user has a photo
                    if (userPhoto && userPhoto.trim()) {
                        // Load user photo
                        const userPhotoImg = new Image();
                        userPhotoImg.crossOrigin = 'anonymous';
                        
                        userPhotoImg.onload = () => {
                            // Draw user photo (circular) with professional styling
                            const photoSize = 160;
                            const photoX = 60;
                            const photoY = detailsStartY + 60;
                            
                            // Draw shadow
                            ctx.save();
                            ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                            ctx.shadowBlur = 15;
                            ctx.shadowOffsetX = 0;
                            ctx.shadowOffsetY = 5;
                            
                            ctx.beginPath();
                            ctx.arc(photoX + photoSize/2, photoY + photoSize/2, photoSize/2, 0, Math.PI * 2);
                            ctx.closePath();
                            ctx.clip();
                            ctx.drawImage(userPhotoImg, photoX, photoY, photoSize, photoSize);
                            ctx.restore();
                            
                            // Draw photo border with gradient
                            const borderGradient = ctx.createLinearGradient(photoX, photoY, photoX, photoY + photoSize);
                            borderGradient.addColorStop(0, '#f59e0b');
                            borderGradient.addColorStop(1, '#d97706');
                            ctx.strokeStyle = borderGradient;
                            ctx.lineWidth = 6;
                            ctx.beginPath();
                            ctx.arc(photoX + photoSize/2, photoY + photoSize/2, photoSize/2, 0, Math.PI * 2);
                            ctx.stroke();
                            
                            // Draw user details and logo
                            drawUserDetailsAndLogo();
                        };
                        
                        userPhotoImg.onerror = () => {
                            // If photo fails to load, skip photo and draw details only
                            console.warn('User photo failed to load, drawing without photo');
                            drawUserDetailsAndLogo();
                        };
                        
                        userPhotoImg.src = userPhoto;
                    } else {
                        // No photo provided, draw details only
                        drawUserDetailsAndLogo();
                    }
                };
                
                promotionImg.onerror = () => {
                    reject(new Error('Failed to load promotion image'));
                };
                
                promotionImg.src = promotionImageUrl;
            });
        }
        
        // Handle confirm download from modal
        document.getElementById('confirmDownloadBtn').addEventListener('click', async function() {
            const { promotionId, language, date } = currentPromotionData;
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('imagePreviewModal'));
            modal.hide();
            
            // Show loading
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Downloading...';
            this.disabled = true;
            
            // Download the promotion (use the already generated preview if available)
            if (currentPreviewDataUrl) {
                // Download directly from preview
                const link = document.createElement('a');
                link.href = currentPreviewDataUrl;
                link.download = `${userName}_${language}_${date.replace(/\//g, '-')}.png`;
                link.click();
            } else {
                // Generate fresh if preview failed
                await downloadPromotion(promotionId, language, date);
            }
            
            // Reset button
            this.innerHTML = '<i class="fas fa-download me-2"></i>Download';
            this.disabled = false;
        });
        
        // Download promotion card
        async function downloadPromotion(promotionId, language, date) {
            
            try {
                console.log(`Downloading promotion: ${promotionId}, Language: ${language}`);
                
                // Fetch promotion image from backend
                const response = await fetch(`${API_BASE_URL}/promotions/image/${promotionId}/${language}`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch promotion image');
                }
                
                const blob = await response.blob();
                const promotionImageUrl = URL.createObjectURL(blob);
                
                // Generate combined card (80% promotion + 20% user details)
                await generatePromotionCard(promotionImageUrl, language, date);
                
            } catch (error) {
                console.error('Error downloading promotion:', error);
                alert('Failed to download promotion. Please try again.');
            }
        }
        
        // Generate promotion card with user details
        async function generatePromotionCard(promotionImageUrl, language, date) {
            return new Promise((resolve, reject) => {
                const canvas = document.getElementById('promotionCanvas');
                const ctx = canvas.getContext('2d');
                
                // Create promotion image element
                const promotionImg = new Image();
                promotionImg.crossOrigin = 'anonymous';
                
                promotionImg.onload = () => {
                    // Set canvas dimensions (1080x1920 pixels)
                    const canvasWidth = 1080;
                    const canvasHeight = 1920;
                    
                    canvas.width = canvasWidth;
                    canvas.height = canvasHeight;
                    
                    // Draw promotion image (85% - top portion)
                    const promoHeight = 1632; // 85% of 1920
                    ctx.drawImage(promotionImg, 0, 0, canvasWidth, promoHeight);
                    
                    // Draw user details section (15% - bottom portion)
                    const detailsStartY = promoHeight;
                    const detailsHeight = 288; // 15% of 1920
                    
                    // Background for user details
                    const gradient = ctx.createLinearGradient(0, detailsStartY, 0, detailsStartY + detailsHeight);
                    gradient.addColorStop(0, '#fef3c7');
                    gradient.addColorStop(1, '#fcd34d');
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, detailsStartY, canvasWidth, detailsHeight);
                    
                    // Function to draw user details, download, and resolve (no logo)
                    const drawDetailsAndDownload = () => {
                        // Determine text starting position based on photo availability
                        const textStartX = userPhoto ? 250 : 60;
                        const textStartY = detailsStartY + 60;
                        
                        // Draw user details text with larger font sizes
                        ctx.fillStyle = '#7c2d12';
                        ctx.font = 'bold 52px Arial';
                        ctx.fillText(userName, textStartX, textStartY);
                        
                        ctx.font = 'bold 46px Arial';
                        ctx.fillText(userPhone, textStartX, textStartY + 65);
                        
                        // Build location path
                        let locationPath = '';
                        if (userCountry) locationPath += `Country: ${userCountry}`;
                        if (userZone) locationPath += ` Zone: ${userZone}`;
                        if (userState) locationPath += ` State: ${userState}`;
                        if (userDivision) locationPath += ` Div: ${userDivision}`;
                        if (userDistrict) locationPath += ` District: ${userDistrict}`;
                        
                        // Draw location path - may wrap to 2 lines if too long
                        if (locationPath) {
                            ctx.font = '36px Arial';
                            ctx.fillStyle = '#92400e';
                            const maxWidth = userPhoto ? 780 : 960;
                            const words = locationPath.split(' ');
                            let line = '';
                            let y = textStartY + 130;
                            
                            for (let word of words) {
                                let testLine = line + word + ' ';
                                let metrics = ctx.measureText(testLine);
                                if (metrics.width > maxWidth && line !== '') {
                                    ctx.fillText(line.trim(), textStartX, y);
                                    line = word + ' ';
                                    y += 45;
                                } else {
                                    line = testLine;
                                }
                            }
                            ctx.fillText(line.trim(), textStartX, y);
                        }
                        
                        // Draw designation in bold
                        if (userDesignation) {
                            ctx.font = 'bold 42px Arial';
                            ctx.fillStyle = '#7c2d12';
                            let desigY = locationPath ? textStartY + 215 : textStartY + 130;
                            ctx.fillText(`Designation: ${userDesignation}`, textStartX, desigY);
                        }
                        
                        // Download the canvas as image (no logo)
                        canvas.toBlob((blob) => {
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = `${userName}_${language}_${date.replace(/\//g, '-')}.png`;
                            link.click();
                            URL.revokeObjectURL(url);
                            resolve();
                        }, 'image/png');
                    };
                    
                    // Check if user has a photo
                    if (userPhoto && userPhoto.trim()) {
                        // Load user photo
                        const userPhotoImg = new Image();
                        userPhotoImg.crossOrigin = 'anonymous';
                        
                        userPhotoImg.onload = () => {
                            // Draw user photo (circular) with professional styling
                            const photoSize = 160;
                            const photoX = 60;
                            const photoY = detailsStartY + 60;
                            
                            // Draw shadow
                            ctx.save();
                            ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                            ctx.shadowBlur = 15;
                            ctx.shadowOffsetX = 0;
                            ctx.shadowOffsetY = 5;
                            
                            ctx.beginPath();
                            ctx.arc(photoX + photoSize/2, photoY + photoSize/2, photoSize/2, 0, Math.PI * 2);
                            ctx.closePath();
                            ctx.clip();
                            ctx.drawImage(userPhotoImg, photoX, photoY, photoSize, photoSize);
                            ctx.restore();
                            
                            // Draw photo border with gradient
                            const borderGradient = ctx.createLinearGradient(photoX, photoY, photoX, photoY + photoSize);
                            borderGradient.addColorStop(0, '#f59e0b');
                            borderGradient.addColorStop(1, '#d97706');
                            ctx.strokeStyle = borderGradient;
                            ctx.lineWidth = 6;
                            ctx.beginPath();
                            ctx.arc(photoX + photoSize/2, photoY + photoSize/2, photoSize/2, 0, Math.PI * 2);
                            ctx.stroke();
                            
                            // Draw details and download
                            drawDetailsAndDownload();
                        };
                        
                        userPhotoImg.onerror = () => {
                            // If photo fails to load, skip photo and draw details only
                            console.warn('User photo failed to load, drawing without photo');
                            drawDetailsAndDownload();
                        };
                        
                        userPhotoImg.src = userPhoto;
                    } else {
                        // No photo provided, draw details only
                        drawDetailsAndDownload();
                    }
                };
                
                promotionImg.onerror = () => {
                    reject(new Error('Failed to load promotion image'));
                };
                
                promotionImg.src = promotionImageUrl;
            });
        }
    </script>
</body>
</html>
